### Redis事务

**事务是指一系列操作步骤，这一系列的操作步骤，要么完全地执行，要么完全地不执行。 Redis 中的事务（transaction）是一组命令的集合，至少是两个或两个以上的命令，redis 事务保证这些命令被执行时中间不会被任何其他操作打断。**



**事务操作的命令 **

**1） multi **

**语法： multi **

**作用：标记一个事务的开始。事务内的多条命令会按照先后顺序被放进一个队列当中。然后才能使用EXEC命令原子化地执行这个命令序列 **

**返回值：总是返回 ok **



**2） exec **

**语法：exec **

**作用：在一个事务中执行所有先前放入队列的命令，然后恢复正常的连接状态。**

**如果在把命令压入队列的过程中报错，则整个队列中的命令都不会执行，执行结果报错；**

**如果在压队列的过程中正常，在执行队列中某一个命令报错，则只会影响本条命令的执行结果，其它命令正常运行**

**返回值：事务内的所有执行语句内容，事务被打断，返回 nil **

**注意：当使用watch命令时，只有当受监控的键没有被修改时，exec命令才会执行事务中的命令**

**而一旦执行了exec命令，之前加的所有watch监控全部取消**



**3） discard **

**语法：discard **

**作用：取消事务，放弃执行事务块内的所有命令 **

**清除所有先前在一个事务中放入队列的命令，并且结束事务。**

**如果使用了watch命令，那么discard命令就会将当前连接监控的所有键取消监控**。

**返回值：总是返回 ok **



**4） watch **

**语法：watch key [key ...] **

**作用：监视一个(或多个) key ，如果在事务执行之前这个(或这些) key 被其他命令所改动， 那么事务将被打断。当某个事务需要按条件执行时，就要使用这个命令将给定的键设置为受监控的。如果被监控的key值在本事务外有修改时，则本事务所有指令都不会被执行。Watch命令相当于关系型数据库中的乐观锁 **

**返回值：总是返回 ok **



**5） unwatch **

**语法：unwatch **

**作用：取消watch命令对所有 key 的监视。如果在执行watch命令之后， exec 命令 或 discard 命令先被执行了的话，那么就不需要再执行 unwatch 了 **

**返回值：总是返回 ok**



**小结：**

**1、单独的隔离操作：事务中的所有命令都会序列化、顺序地执行，入队列的时候语法都错了的话，就不会执行。事务在执行过程中，不会被其它客户端发来的命令请求所打断，除非使用watch命令监控某些键。**

**2、不保证事务的原子性：redis同一个事务中如果一条命令执行失败，其后的命令仍然可能会被执行，redis的事务没有回滚。Redis已经在系统内部进行功能简化，这样可以确保更快的运行速度，因为Redis不需要事务回滚的能力。**

**Redis 这种设计原则是：Redis 命令只会因为错误的语法而失败（这些问题不能在入队时发 现），或是命令用在了错误类型的键上面，失败的命令并不是 Redis 导致，而是由编程错误 造成的，这样错误应该在开发的过程中被发现，生产环境中不应出现语法的错误。就是在 程序的运行环境中不应该出现语法的错误。而 Redis 能够保证正确的命令一定会被执行。 再者不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速**