### 手写断路器思路





![断路器思路](E:\笔记整理\动力节点SpringCloud\图解\断路器思路.png)

**断路器实际上就是一个拦截器，请求在走B之前，查看断路器是否打开**

**默认情况下：断路器关闭，正常去访问远程服务**

**一段时间内调用远程服务失败次数达到阈值，断路器再打开**

**注意：并不是一次不成功，就认为远程服务失败，一般是在一个时间段内达到了阈值，才认为这个远程服务不可用**

**这样就缓解了雪崩问题**



**新问题：远程服务恢复正常了，怎么检测，并关闭断路器**

**再设计一个半开的开关，允许少数的请求去尝试发起一下远程调用，如果发现正常了，就把之前的断路器关闭**



**断路器三种状态：关闭【默认】 打开  半开**





**关：服务正常调用 A---》B **

**开：在一段时间内，调用失败次数达到阀值（5s 内失败 3 次）（5s 失败 30 次的）则断路器 打开，直接 return **

**半开：断路器打开后，过一段时间，让少许流量尝试调用 B 服务，如果成功则断路器关闭， 使服务正常调用，如果失败，则继续半开**