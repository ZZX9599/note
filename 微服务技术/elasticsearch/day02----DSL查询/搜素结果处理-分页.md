### 搜素结果处理-分页



**之前就算是查全部，也只能查到十条，因为默认就是十条，可以自行修改**

**elasticsearch 默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了**

**elasticsearch中通过修改from、size参数来控制要返回的分页结果**



**语法：**

```apl
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "from": 990, // 分页开始的位置，默认为0
  "size": 10, // 期望获取的文档总数
  "sort": [
    {"price": "asc"}
  ]

```



```apl
#分页
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "price": "desc"
    }
  ],
  "from": 1,
  "size": 20
}
```

**form默认为0，size默认为10**





### **深度分页**



**ES是分布式的，所以会面临深度分页问题。例如按price排序后，获取from = 990，size =10的数据**

**也就是查询991-1000的这十条数据**

**集群中每个ES里面的数据是不一样的，所以集群分页并不简单**

**1.首先在每个数据分片上都排序并查询前1000条文档。**

**2.然后将所有节点的结果聚合，在内存中重新排序选出前1000条文档**

**3.最后从这1000条中，选取从990开始的10条文档**

**如果搜索页数过深，或者结果集（from + size）越大**

**对内存和CPU的消耗也越高。因此ES设定结果集查询的上限是10000**



**from+size的和超过10000，就会报错！**





### **深度分页解决方案**

**•search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。**

**不支持前置翻页，只能往后面翻页**



**•scroll：原理将排序数据形成快照，保存在内存。官方已经不推荐使用。**

**由于是快照，所以数据更新的话，必须自己手动更新，不更新的话，数据就不同步**





### 总结：

**from + size：**

**•优点：支持随机翻页**

**•缺点：深度分页问题，默认查询上限（from + size）是10000**

**•场景：百度、京东、谷歌、淘宝这样的随机翻页搜索**



**after search：**

**•优点：没有查询上限（单次查询的size不超过10000）**

**•缺点：只能向后逐页查询，不支持随机翻页**

**•场景：没有随机翻页需求的搜索，例如手机向下滚动翻页**



**scroll：**

**•优点：没有查询上限（单次查询的size不超过10000）**

**•缺点：会有额外内存消耗，并且搜索结果是非实时的**

**•场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案**。